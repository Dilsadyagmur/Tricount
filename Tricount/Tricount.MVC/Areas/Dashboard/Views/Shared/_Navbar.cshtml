@using Microsoft.AspNetCore.Identity;
@using Microsoft.EntityFrameworkCore;
@using Tricount.BL.Abstract;
@using Tricount.Entities.Concrete;

@inject UserManager<User> userManager;
@inject IInviteManager inviteManager;
@inject IExpenseManager expenseManager;
@{
    var user = await userManager.GetUserAsync(User);

    var inviteRaw = inviteManager.GetAllInclude(i => i.UserId == user.Id, i => i.Group).Result;
    var invites = inviteRaw.Where(i => i.IsFinished == false).ToList();

    var expenseRaw = expenseManager.GetAllInclude(e => e.PayerId == user.Id, e => e.ExpenseDetails).Result;
    var expenses = expenseRaw.Where(e => e.IsFinished == false).ToList();

    var expenseCount = 0;
    foreach (var expense in expenses)
    {
        if (expense.ExpenseDetails.Count > 0 && expense.ExpenseDetails.FirstOrDefault().IsPaid == true && expense.ExpenseDetails.FirstOrDefault().IsApproved == false)
        {
            expenseCount++;
        }
    }
    var notificationCount = expenseCount + invites.Count;
}

<!-- Navbar -->
<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="/dashboard/menu" class="nav-link">Home</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link">Contact</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown2" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Help
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown2">
                <a class="dropdown-item" href="#">FAQ</a>
                <a class="dropdown-item" href="#">Support</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#">Contact</a>
            </div>
        </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
        <!-- Notifications Dropdown Menu -->
        <li class="nav-item mx-3">
            <a class="nav-link" data-bs-toggle="modal" data-bs-target="#createGroupModal" style="cursor:pointer">
                <i class="fas fa-plus"></i>
                <span class="badge badge-success">Add Group</span>
            </a>
        </li>

        <li class="nav-item dropdown mx-3">
            <a class="nav-link" data-toggle="dropdown" href="#">
                <i class="far fa-bell"></i>
                <span class="badge badge-warning">@notificationCount</span>
            </a> 
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right p-3">
                <span class="dropdown-header">@notificationCount Notifications</span>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item p-3" data-bs-toggle="modal" data-bs-target="#NotificationModal">
                    <i class="fas fa-envelope mr-2"></i> @invites.Count New Group Invite
                    <span class="float-right text-muted text-sm">3 mins</span>
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item p-3" data-bs-toggle="modal" data-bs-target="#NotificationModal">
                    <i class="fas fa-check mr-2"></i> @expenseCount New Payment Confirmation
                    <span class="float-right text-muted text-sm">12 hours</span>
                </a>
                <div class="dropdown-divider"></div>
            </div>
        </li>
    </ul>
</nav>
<!-- /.navbar -->

<partial name="_NotificationModal"></partial>
<partial name="_CreateModal"></partial>